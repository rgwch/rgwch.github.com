---
layout: post
title: Docker
description: Dockerfile für Webelexis
category: Programmieren Allgemein
tags: [docker]
---

Auch [Docker](https://www.docker.com) gehört zu den Tools, die ich schon lange in meiner "Todo" bzw. "ToLookAt" Schublade habe.

## Installation

Wer einen Mac mit homebrew hat, ist fein raus:

    brew install docker
    brew install boot2docker
    boot2docker init
    boot2docker up
    
fertig.

Für andere Betriebsysteme stellt Docker [Installationsanleitungen](https://docs.docker.com/installation/#installation) bereit.
Bottomline: Man braucht ein halbwegs aktuelles 64-Bit Betriebssystem.

## Kleiner Crashkurs

* `docker images`             : Listet alle geladenen Images
* `docker pull image`         : Holt das genannte Image
* `docker run image`          : Erstellt und startet einen Container vom genannten Image (Lädt das Image ggf. zuerst herunter, falls lokal noch
nicht vorhanden. 
* `docker run -t -i image sh` : Erstellt einen Container und startet ihn im interaktiven Modus mit Terminal
* `docker ps -a`              : Listet alle Container
* `docker rm container`       : löscht einen Container
* `docker rmi image`          : löscht ein image
* `docker start -t container` : Einen bestehenden Container starten

**Achtung** Möglicher Denkfehler mit hohem Zeitverlustrisiko: Wenn Sie ein image mit `docker run` starten, darin eine Menge ändern,
und es dann verlassen, sind Ihre
Änderungen keinesegs im Image gespeichert, sondern nur im Container. Den können Sie erneut starten mit `docker start` . Wenn
Sie stattdessen erneut `docker run` eingeben, erhalten Sie einen neuen Container, der nichts von Ihren Änderungen enthält. 
Sie können Änderungen in ein neues Image persistieren, indem Sie `docker commit` verwenden. Bottomline: Es lohnt sich,
über den Unterschied zwischen *Image* und *Container* nachzudenken: Ein *Image* ist ein read-only Abbild eines lauffähigen Systems.
Ein *Container* ist ein "zum Leben erweckter" Abzug eines Image. Dieser verändert das Image niemals, egal was man damit anstellt.


## Webelexis-Image herunterladen und Container starten:

    1. docker run -p 2015:2015 -i -t rgwch/webelexis-docker:1.0.0 sh

Das war's. Man kann Webelexis in der VM mit `java -jar webelexis-server-1.0.0.jar` starten, und Webelexis ist dann
in Linux unter localhost:2015 erreichbar, in Mac und Windows 
unter der IP der docker VM, welche man mit `boot2docker ip` erfragen kann.

## Webelexis-Container selber bauen

Hier ein Dockerfile, um einen Webelexis Container zu erstellen. Als Basis nahm ich die Java-Maschine von [1Science](http://www.1science.com),
 welche ihrerseits auf [Alpine Linux](http://alpinelinux.org) basiert, dessen 
hervorstechendste Eigenschaft die geringe Grösse ist (5 MB vs 130 MB (Ubuntu) oder 200 MB (Arch) für den Basis-Container).
Wenn dieses Dockerfile fertig ist, sind allerdings trotzdem 300MB daraus geworden...


     FROM 1science/java:oracle-jdk-8
     MAINTAINER weirich@elexis.ch
     RUN apk add --update git nodejs nano
     RUN wget http://ftp.fau.de/apache/maven/maven-3/3.3.1/binaries/apache-maven-3.3.1-bin.tar.gz
     RUN tar -xzf apache-maven-3.3.1-bin.tar.gz
     RUN rm -f apache-maven-3.3.1-bin.tar.gz
     RUN mv apache-maven-3.3.1 /usr/lib/mvn
     ENV M2_HOME=/usr/lib/mvn
     ENV M2=$M2_HOME/bin
     ENV PATH $PATH:$M2_HOME:$M2
     RUN npm install -g mimosa
     RUN adduser -D -s bash webelexis
     USER webelexis
     WORKDIR /home/webelexis
     RUN git clone https://github.com/rgwch/webelexis
     WORKDIR /home/webelexis/webelexis/webelexis-client
     RUN mimosa build
     WORKDIR /home/webelexis/webelexis/webelexis-server
     RUN mvn package
     EXPOSE 2015
     WORKDIR /home/webelexis/webelexis/webelexis-server/target
     RUN java -jar webelexis-server-1.0.0.jar
     RUN cp cfglocal.json ../cfglocal.json
     

Vorgehen:

* Verzeichnis webelexis-docker erstellen
* Dort eine Datei namens DOCKERFILE mit obenstehendem Inhalt erstellen, dann dort Terminal öffnen und folgendes eingeben:
 `docker build -t repo/name:tag .`(wobei Sie für reppName:tag etwas für Sie passendes eingeben können).
* Gehen Sie einen Kaffee trinken.
* nach ziemlich langer Zeit wird docker das Image erstellt haben
* Erstellen und starten Sie einen Container mit `docker run -i -t -p 2015:2015 repo/name:tag sh`
* Editieren Sie webelexis/cfglocal.json
* committen Sie die Änderungen mit `docker commit`

Fertig ist Ihr webelexis-image, das Sie auf jeder mit Docker ausgestatteten Maschine starten können.


    